(function(g){var j=Math.max,e=function(a,d,c){var b=this;b._eventBus=a;b._configuration=d;b._loaded=b._playerReady=!1;b._videoStrategy=this.findBestTranscode;b._videos=c;b._index=-1;b._qualitySet=[];a.subscribe("qualityToggled",b.onQualityToggled,b);a.subscribe("UI.ready",b.findBestTranscode,b);a.subscribe("Playlist.videoSelected",b._videoSelected,b);a.subscribe("Player.fullready",function(){b._playerReady=!0;a.subscribe("resize",b.findBestTranscode,b)},b);a.subscribe("unusable-transcode",b._removeBadTranscode,
b)},h={hq:"getHighDefinitionTranscode","best-fit":"findBestTranscode"};e.prototype.onQualityToggled=function(a){a&&a.state in h&&("best-fit"==a.state&&(this._index=-1,this._hd=!1),this._videoStrategy=this[h[a.state]],this._videoStrategy(a))};e.prototype._processVideo=function(a){var d={name:a.name,id:a.id,duration:a.duration,qualities:[]},c=a.transcodes;Object.keys(c).forEach(function(a){c[a].forEach(function(c){var f={name:c.width+"x"+c.height,width:c.width,height:c.height,urls:{}},e=d.qualities.filter(function(a){return a.name==
f.name});0<e.length?e[0].urls[a]=c.url:(f.urls[a]=c.url,d.qualities.push(f))})});d.qualities=d.qualities.sort(function(a,c){return a.height<c.height?-1:a.height>c.height?1:0});return d};e.prototype._broadcastQuality=function(a){if(a.name!==this._current){this._current=a.name;var d=!this._loaded?"Player.load":"Player.changeSource";this._loaded=!0;this._eventBus.broadcast(d,[{url:a.urls}]);this._eventBus.broadcast("Quality.selectedQuality",[a])}};e.prototype.findBestTranscode=function(a){a||(a={});
var d=this._qualitySet,c=j(this._index,0),b=this._hd?0:a.max,e=j(d.length-1,0),f=$(g),h=a.height||f.height();a=a.width||f.width();if(d.length){for(!this._hd&&(navigator.connection&&3==navigator.connection.type)&&(b=720);f=d[c];c++){if(b&&f.height>=b){f=d[c=j(c-1,0)];break}if(c===e||f.height>=h||f.width>=a)break}if(f&&(-1===this._index||c>=this._index))this._index=c,this._broadcastQuality(f)}else this._eventBus.broadcast("no-transcodes-available"),this._eventBus.broadcast("log-error",["no-transcodes-available",
{}])};e.prototype.getHighDefinitionTranscode=function(a){this._hd=!0;var d=0,c=this._qualitySet,b;if(c.length){for(;b=c[d++];)if(720<=b.height){this._index=d-1;this.findBestTranscode(a);break}b||this._broadcastQuality(c[this._index=c.length-1])}else this._eventBus.broadcast("no-transcodes-available"),this._eventBus.broadcast("log-error",["no-transcodes-available",{}])};e.prototype._videoSelected=function(a){this._qualitySet=this._processVideo(this._videos[a.video.index]).qualities;this._current=this._loaded=
!1;this._index=-1;this._playerReady&&this._videoStrategy()};e.prototype._removeBadTranscode=function(){var a={};-1<this._index&&(a.max=this._qualitySet.splice(this._index--,1)[0].height,0>this._index&&(this._index=0));this._videoStrategy(a)};g.uStudio=g.uStudio||{};g.uStudio.Quality=e;uStudio.uStudioCore.instance.registerModule({name:"uStudioQuality",initialize:function(a,d,c,b){new e(d,a,c);b()}})})(this);
