var uStudioFlashBridge={flashCallback:function(g){g.data?uStudioFlashBridge.eventbus.broadcast(g.type,[g.data]):uStudioFlashBridge.eventbus.broadcast(g.type)},onSwfLoaded:function(){console.log("uStudioFlashBridge.onSwfLoaded");return!0}};
(function(g){var k=function(a,b,c,d){var f=function(){a.removeEventListener(b,f);return c.apply(d||a,arguments)};a.addEventListener(b,f)},j=function(a,b,c,d,f,h){this._document=a.document;this._eventBus=b;this._currentVideo=f[0];uStudioFlashBridge.eventbus=b;this._configuration=c;this._swfobject=d;this._video="";this._canPlayTypes=[];this._playerVars={};this._showCaptions=!1;this._firstLoad=!0;this._showCaptionValue="showing";this._hideCaptionValue="hidden";this._browserType=this.detectBrowserType(a.navigator.userAgent);
this._preferredType=this.detect();"html5"===this._preferredType&&this.addCommandListenersHTML5();b.subscribe("Player.build",this.build,this);b.subscribe("Playlist.videoSelected",this._onVideoSelected,this);b.subscribe("showCaptions",this._onShowCaptions,this);b.subscribe("hideCaptions",this._onHideCaptions,this);h(this.filterVideos(f))},e=j.prototype;j.ELEMENT_CLASS="ustudio-player";j.ELEMENT_ID="ustudioplayer";var l=function(a){var b="",c=0;if(a)for(;c<a.length;c++)b+=a.start(c).toFixed(3)+"-"+a.end(c).toFixed(3)+
",";return b};j.getDebugInfo=function(a){return{buffered:l(a.buffered),currentTime:a.currentTime.toFixed(3),duration:a.duration.toFixed(3),errorCode:a.error?a.error.code:null,networkState:a.networkState,paused:a.paused,playbackRate:a.playbackRate,played:l(a.played),readyState:a.readyState,seeking:a.seeking}};e.log=function(){};e.error=function(a,b){var c=b&&b.target,d=this._eventBus,f,h;if(c){h=this.createError(j.getDebugInfo(c));if(c.networkState===HTMLMediaElement.NETWORK_EMPTY&&c.readyState===
HTMLMediaElement.HAVE_ENOUGH_DATA&&c.error&&c.error.code===MediaError.MEDIA_ERR_NETWORK){d.broadcast("log-error",["network",h]);f=c.currentTime;d.broadcast("Player.pause");d.broadcast("Player.sourceChanging");k(c,"loadedmetadata",function(){d.broadcast("Player.paused");this.currentTime=f});c.load();return}if(c.networkState===HTMLMediaElement.NETWORK_NO_SOURCE){h.transcodeURL=c.currentSrc;d.broadcast("unusable-transcode",[c.currentSrc]);d.broadcast("log-error",["unusable-transcode",h]);return}}else h=
this.createError(b);d.broadcast("Player.error",[h]);d.broadcast("log-error",[a,h])};e.createError=function(a){return{errorMessage:a,playerVars:this._playerVars,firstLoad:this._firstLoad}};e.detectBrowserType=function(a){return{seekedNotEmitted:/android/i.test(a)&&!/chrome/i.test(a),seekAfterProgress:/i(phone|pod|pad)/i.test(a)&&/os [1-6]/i.test(a),videoCapturesOverlayEvents:/i(phone|pod)/i.test(a)}};e._onVideoSelected=function(a){this._currentVideo=a.video};e._forEachCaptionTracks=function(a){var b,
c;if(this._video.textTracks)for(c=0;c<this._video.textTracks.length;c++)b=this._video.textTracks[c],"captions"===b.kind&&a(b)};e._onShowCaptions=function(){var a=this;this._forEachCaptionTracks(function(b){b.mode=a._showCaptionValue});this._showCaptions=!0;this._eventBus.broadcast("captionsVisible")};e._onHideCaptions=function(){var a=this;this._forEachCaptionTracks(function(b){b.mode=a._hideCaptionValue});this._showCaptions=!1;this._eventBus.broadcast("captionsHidden")};e.dispatchToFlash=function(a,
b){this._document.getElementById("flashplayer").dispatchToFlash(a,b)};e.html5SupportedTypes=function(){var a=this._document.createElement("video"),b=[],c=[];if(!a.canPlayType)return b;c.push({type:"webm",probability:a.canPlayType('video/webm; codecs="vp8, vorbis"')});c.push({type:"mp4",probability:a.canPlayType('video/mp4; codecs="avc1.4D401E, mp4a.40.2"')});b=c.sort(function(a,b){if(a.probability===b.probability){if("mp4"===a.type)return-1;if("mp4"===b.type)return 1}else{if("probably"===a.probability)return-1;
if("probably"===b.probability)return 1}return 0}).reduce(function(a,b){("probably"===b.probability||"maybe"===b.probability)&&a.push(b.type);return a},[]);if(a.textTracks){c=this._document.getElementsByTagName("body")[0];a.appendChild(this._document.createElement("track"));c.appendChild(a);var d=a.textTracks[0],d=d&&d.mode;c.removeChild(a);"number"===typeof d&&(this._showCaptionValue=2,this._hideCaptionValue=0)}return b};e.getTranscodeType=function(){var a=this._canPlayTypes;1>a.length&&this.log("playlist: could not find any HTML5 video compatible formats");
return a[0]};e.seekToCurrentTimeAfterSeeking=function(a,b){k(this._video,"seeking",function(){this._sourceChanging=!1;b?this._video.play():this._eventBus.broadcast("Player.paused",[]);this._eventBus.broadcast("Player.sourceChanged",[])},this);this._video.currentTime=a};e.seekToCurrentTimeAfterProgress=function(a,b){var c=function(){this._sourceChanging=!1;b?this._video.play():this._eventBus.broadcast("Player.paused",[]);this._eventBus.broadcast("Player.sourceChanged",[])};k(this._video,"progress",
function(){k(this._video,"seeked",c,this);this._video.currentTime=a},this)};e.seekToCurrentTimeDefault=function(a,b){k(this._video,"seeked",function(){this._sourceChanging=!1;b?this._video.play():this._eventBus.broadcast("Player.paused",[]);this._eventBus.broadcast("Player.sourceChanged",[])},this);this._video.currentTime=a};e.addCommandListenersHTML5=function(){var a=this;a._eventBus.subscribe("Player.play",function(){a._video.play()});a._eventBus.subscribe("Player.pause",function(){a._video.pause()});
a._eventBus.subscribe("Player.seek",function(b){b=a._video.currentTime+b.value;a._video.seekable&&(a._video.currentTime=b)});a._eventBus.subscribe("Player.seekto",function(b){b=b.value;a._video.seekable&&(a._video.currentTime=b)});a._eventBus.subscribe("Player.mute",function(){a._video.muted=!a._video.muted;a._eventBus.broadcast("Player.mutedchanged",[{muted:a._video.muted}])});a._eventBus.subscribe("Player.changeVolume",function(b){b=b.level;1>=b&&0<b&&(a._video.volume=b)});a._loadedListener=function(){a.forwardHTMLLoaded()};
a._eventBus.subscribe("Player.load",function(b){a._firstLoad=!0;a._video||a.createHTML5Element(a._playerContainerID);a._video.addEventListener("loadeddata",a._loadedListener,!1);a.loadHTML5Video(b.url)});a._eventBus.subscribe("Player.changeSource",function(b){if(!a._sourceChanging){var c=!a._video.paused,d=a._video.currentTime;a._sourceChanging=!0;a._eventBus.broadcast("Player.sourceChanging",[]);k(a._video,"loadeddata",d||c?function(){this.seekToCurrentTime(d,c)}:function(){a._sourceChanging=!1;
a._eventBus.broadcast("Player.sourceChanged",[]);a._loadedListener()},a);a.loadHTML5Video(b.url)}})};e.loadHTML5Video=function(a){var b=this,c;c=b._canPlayTypes.filter(function(b){return void 0!==a[b]});if(0===c.length)b._eventBus.broadcast("no-transcodes-available"),b._eventBus.broadcast("log-error",["no-transcodes-available",{}]);else{for(;b._video.hasChildNodes();)b._video.removeChild(b._video.firstChild);c=a[c[0]];c+=0<=c.indexOf("?")?"&":"?";c+="random="+Math.floor(1E8*Math.random());b._video.src=
c;var d={caption:function(a){var c=b._document.createElement("track");c.kind="captions";c.src=a.url;b._video.appendChild(c);b._eventBus.broadcast("captionsAvailable")}},f=!1;b._currentVideo&&b._currentVideo.files&&b._currentVideo.files.forEach(function(a){var c=d[a.name];c&&(c(a,b._video),f=!0)});(!f||!b._video.textTracks)&&b._eventBus.broadcast("captionsUnavailable");var h=b._showCaptions?b._showCaptionValue:b._hideCaptionValue;b._forEachCaptionTracks(function(a){a.mode=h});b._firstLoad?b._firstLoad=
!1:b._video.load()}};e.addCommandListenersFlash=function(){var a=this;$.each(["Player.play","Player.pause","Player.seek","Player.seekto","Player.mute"],function(b,d){a._eventBus.subscribe(d,function(b){a.dispatchToFlash(d,b)})});a._eventBus.subscribe("Player.changeVolume",function(b){b=b.level;1>=b&&0<b&&a.dispatchToFlash("Player.changeVolume",{level:b})});var b=function(b,d){d.url.mp4?a.dispatchToFlash(b,{url:d.url.mp4}):(a._eventBus.broadcast("no-transcodes-available"),a._eventBus.broadcast("log-error",
["no-transcodes-available",{}]))};a._eventBus.subscribe("Player.load",function(a){b("Player.load",a)});a._eventBus.subscribe("Player.changeSource",function(a){b("Player.changeSource",a)})};e.addVideoListeners=function(){var a=this,b=a._eventBus,c=a._video;a._video.addEventListener("progress",function(){var b=0,c=a._video.duration,d=a._video.buffered.length;0<c&&0<d&&(b=100*(a._video.buffered.end(d-1)/c));a._eventBus.broadcast("Player.buffered",[{percentage:b}])},!1);a._video.addEventListener("error",
function(b){a.error("HTML5",b)},!1);a._video.addEventListener("canplay",function(){a._eventBus.broadcast("Player.canplay");a.log("canplay")},!1);a._video.addEventListener("ended",function(){a._eventBus.broadcast("Player.timeupdate",[{currentTime:a._video.duration}]);a._eventBus.broadcast("Player.ended")},!1);a._video.addEventListener("timeupdate",function(){a._eventBus.broadcast("Player.timeupdate",[{currentTime:a._video.currentTime}]);a.log("timeupdate")},!1);a._video.addEventListener("durationchange",
function(){a._eventBus.broadcast("Player.durationchange",[{duration:a._video.duration}]);a.log("durationchange")},!1);a._video.addEventListener("waiting",function(){a._eventBus.broadcast("Player.waiting");a.log("waiting")},!1);a._video.addEventListener("playing",function(){a._eventBus.broadcast("Player.playing");a.log("playing")},!1);a._video.addEventListener("volumechange",function(){a._eventBus.broadcast("Player.volumechange",[{volume:a._video.volume}]);a.log("volumechange")},!1);a._video.addEventListener("seeking",
function(){a._eventBus.broadcast("Player.seeking");a.log("seeking")},!1);a._video.addEventListener("seeked",function(){a._eventBus.broadcast("Player.seeked",[{currentTime:a._video.currentTime}]);a.log("seeked")},!1);a._video.addEventListener("loadstart",function(){a._eventBus.broadcast("Player.loading");a.log("loadstart")},!1);a._video.addEventListener("pause",function(){a._eventBus.broadcast("Player.paused");a.log("pause")},!1);var d=function(a){b.broadcast("fullscreen-change",[{state:"webkitbeginfullscreen"==
a.type}])};c.addEventListener("loadedmetadata",function(){var a=c.webkitEnterFullscreen;c.webkitSupportsFullscreen&&a&&(b.subscribe("fullscreen-on",function(b){"player"==b.source&&a.call(c)}),b.broadcast("fullscreen-capable",[{source:"player",weight:20}]),c.addEventListener("webkitbeginfullscreen",d,!1),c.addEventListener("webkitendfullscreen",d,!1))},!1)};e.forwardHTMLLoaded=function(){this._video.removeEventListener("loadeddata",this._loadedListener);this._eventBus.broadcast("Player.loaded")};e.detect=
function(){for(var a=0,b=this._configuration.player_types,c=[],d,f;f=b[a++];){if("html5"===f.type&&(c=this.html5SupportedTypes(),c.length)){d="html5";this.seekToCurrentTime=this._browserType.seekedNotEmitted?this.seekToCurrentTimeAfterSeeking:this._browserType.seekAfterProgress?this.seekToCurrentTimeAfterProgress:this.seekToCurrentTimeDefault;break}if("flash"===f.type)if(this._swfobject.hasFlashPlayerVersion("10.2")){c=["mp4"];d="flash";break}else this.log("No support for minimum flash version")}this._playerVars=
f;this._canPlayTypes=c;return d||"no video"};e.filterVideos=function(a){var b=this;return a.reduce(function(a,d){var f,e,g={transcodes:{}},j=0;for(f in d.transcodes)d.transcodes.hasOwnProperty(f)&&!(0>b._canPlayTypes.indexOf(f))&&(j++,g.transcodes[f]=d.transcodes[f]);if(0<j){for(e in d)d.hasOwnProperty(e)&&"transcodes"!==e&&(g[e]=d[e]);a.push(g)}return a},[])};e.createFlashVideoElement=function(a){var b=this,c={},d={},e={},h,g=a+"_flashPlaceholder",c=this._playerVars;d.quality="high";d.bgcolor="#000000";
d.allowfullscreen="true";d.allowScriptAccess="always";d.wmode="opaque";e.id="flashplayer";e.name="flashplayer";e.align="middle";a=b._document.getElementById(a);h=b._document.createElement("div");h.setAttribute("id",g);a.appendChild(h);b.addCommandListenersFlash();b._swfobject.embedSWF(b._playerVars.swf_path,g,"100%","100%","10.2.0","playerProductInstall.swf",c,d,e,function(a){a.success?b._eventBus.broadcast("Player.flashplayerEmbeded"):b.error("FLASH_NOT_LOADED","Flash player not loaded")});b._swfobject.createCSS("#flashContent",
"display:block;text-align:left;")};e.createHTML5Element=function(a){var b=this._video=this._document.createElement("video");b.className=j.ELEMENT_CLASS;b.id=j.ELEMENT_ID;b.controls="on"===this._playerVars.controls?"controls":!1;b.height=this._configuration.height;b.width=this._configuration.width;b.style.height=b.style.width="100%";this.addVideoListeners();if(this._browserType.videoCapturesOverlayEvents){var c,d=function(){c=b.style.marginLeft;b.style.marginLeft="-100%"};d();b.addEventListener("playing",
function(){b.style.marginLeft=c});b.addEventListener("ended",d)}this._document.getElementById(a).appendChild(b);this._eventBus.broadcast("Player.volumechange",[{volume:this._video.volume}])};e.build=function(a){"no video"===this._preferredType?this.error("NOT_SUPPORTED","video not supported"):(this._eventBus.broadcast("Player.canPlayTypes",[{transcodes:this._canPlayTypes}]),"html5"===this._preferredType?(this._playerContainerID=a,this._eventBus.broadcast("Player.fullready")):"flash"===this._preferredType&&
this.createFlashVideoElement(a),this._eventBus.broadcast("Player.start"))};g.uStudio=g.uStudio||{};g.uStudio.Player=j;uStudio.uStudioCore.instance.registerModule({name:"uStudioPlayer",initialize:function(a,b,c,d){new j(g,b,a,swfobject,c,d)}})})(this);
