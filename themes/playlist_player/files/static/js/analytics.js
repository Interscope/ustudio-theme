(function(){var d=Math.floor,c=function(a,b,c){this._eventBus=a;this._configuration=b;this._videos=c;this._activityId=b.activity_uid;this._currentVideo=c[0];this._impressedVideos={};this._resetVideoState();this.log=function(){};this._addEventListeners();this.log("Analytics::Created");this._validateConfiguration()?this._eventBus.subscribe("start",this._onStart,this):this.log("Analytics::Not Listening.")};c.prototype._addEventListeners=function(){var a=this;a._eventBus.subscribe("Player.durationchange",
function(b){a.log("Analytics Module received durationchange event.");a.log(b);a._duration=b.duration});a._eventBus.subscribe("Analytics.setActivityId",function(b){a._activityId=b});a.log("Analytics::Adding Listeners");a._eventBus.subscribe("Player.playing",a._onPlay,a);a._eventBus.subscribe("Player.timeupdate",a._onTimeUpdate,a);a._eventBus.subscribe("Player.seeked",a._onSeeked,a);a._eventBus.subscribe("Player.ended",a._onEnded,a);a._eventBus.subscribe("Playlist.videoSelected",a._onVideoSelected,
a)};c.prototype._resetVideoState=function(){this._playing=!1;this._lastProgress=-1};c.prototype._sendApiStatsRequest=function(a,b){var c=this,d="/api/v2/studios/"+c._configuration.studio_uid+"/"+a+"/add",f={vid:c._currentVideo.id,did:c._configuration.destination_uid};this._activityId&&(f.aid=c._activityId);b&&Object.keys(b).forEach(function(a){f[a]=b[a]});$.ajax({url:d,data:f,cache:!1,success:function(){c.log("Analytics::Successfully sent "+a+" request to uStudio API")}}).error(function(a,b){throw new e("Analytics::Unable to send request to ("+
d+"). Reason: "+b);})};c.prototype._onPlay=function(){this.log("Analytics::Playing");this._playing||(this._playing=!0,this._sendApiStatsRequest("plays"),this._onTimeUpdate({currentTime:0}))};c.prototype._onTimeUpdate=function(a){var b=this._calculateProgressPercent(a.currentTime);this.log("Analytics::Time Update to: "+a.currentTime);0>b||(100<b||!this._playing)||(a=d(b/10),b=d(this._lastProgress/10),a>b&&(this.log("Analytics:: Sending Progress report of "+10*a),this._sendApiStatsRequest("progress",
{progress:10*a}),this._lastProgress=10*a))};c.prototype._onSeeked=function(a){var b=this._calculateProgressPercent(a.currentTime);this.log("Analytics::Seeked to time:"+a.currentTime);this._lastProgress!=b&&(this._lastProgress=10*d(b/10))};c.prototype._onEnded=function(){this.log("Analytics::Ended");this._resetVideoState()};c.prototype._registerImpression=function(){var a=this._currentVideo.id;this._impressedVideos[a]||(this._sendApiStatsRequest("impressions"),this._impressedVideos[a]=!0)};c.prototype._onVideoSelected=
function(a){this._currentVideo=this._videos[a.video.index];this._resetVideoState();this._registerImpression()};c.prototype._onStart=function(){this.log("Analytics::Start");this._currentVideo&&this._registerImpression()};c.prototype._calculateProgressPercent=function(a){if(!this._duration)return 0;var b=d(100*(a/this._duration));this.log("Analytics::Calculating Progress Percent: "+a+" / "+this._duration+" * 100 = "+b);return b};c.prototype._validateConfiguration=function(){return!("studio_uid"in this._configuration)?
(this.log("Analytics::Configuration Validation Failed: No Studio UID."),!1):!("destination_uid"in this._configuration)?(this.log("Analytics::Configuration Validation Failed: No Destination UID."),!1):!0};var e=function(a){this.name="APIRequestError";this.message=a||"uStudio API Request Error."};e.prototype=Error();e.prototype.constructor=e;window.uStudio=window.uStudio||{};window.uStudio.Analytics=c;uStudio.uStudioCore.instance.registerModule({name:"uStudioAnalytics",initialize:function(a,b,c,d){(new uStudio.Analytics(b,
a,c)).log("Analytics::Registered");d()},queryConfigMap:{aid:"activity_uid"}})})();
